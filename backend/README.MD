# Patient Assistant API

## ğŸ“ Proje YapÄ±sÄ±

```
patient-assistant-api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ __init__.py              # Ana paket
â”‚   â”œâ”€â”€ main.py                  # FastAPI uygulamasÄ± ve startup
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ settings.py          # KonfigÃ¼rasyon ayarlarÄ±
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py            # Auth Pydantic modelleri
â”‚   â”‚   â”œâ”€â”€ routes.py            # Auth endpoint'leri
â”‚   â”‚   â”œâ”€â”€ service.py           # Auth iÅŸ mantÄ±ÄŸÄ± ve Firebase entegrasyonu
â”‚   â”‚   â””â”€â”€ dependencies.py      # Firebase auth ve token doÄŸrulama
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ models.py            # Chat Pydantic modelleri
â”‚   â”‚   â”œâ”€â”€ routes.py            # Chat endpoint'leri
â”‚   â”‚   â””â”€â”€ service.py           # Chat iÅŸ mantÄ±ÄŸÄ±
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ model_manager.py     # ML model yÃ¶netimi
â”‚   â”‚   â””â”€â”€ session_manager.py   # Session ve memory yÃ¶netimi
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ prompts.py           # Sistem prompt'larÄ±
â”œâ”€â”€ .env                         # Environment variables
â”œâ”€â”€ requirements.txt             # Python baÄŸÄ±mlÄ±lÄ±klarÄ±
â””â”€â”€ README.md
```

## ğŸš€ Kurulum

### 1. Virtual environment oluÅŸturun

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# veya
venv\Scripts\activate     # Windows
```

### 2. BaÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¼kleyin

```bash
pip install -r requirements.txt
```

### 3. Environment variables ayarlayÄ±n

`.env` dosyasÄ± oluÅŸturun:

```env
API_KEY=your_firebase_api_key
MESSAGING_SENDER_ID=your_messaging_sender_id
APP_ID=your_app_id
FIREBASE_SERVICE_ACCOUNT_PATH=path/to/service-account.json
```

### 4. UygulamayÄ± Ã§alÄ±ÅŸtÄ±rÄ±n

```bash
python -m app.main
# veya
uvicorn app.main:app --reload
```

## ğŸ“š API Endpoints

### ğŸ” Authentication

- `POST /auth/signup` - KullanÄ±cÄ± kaydÄ± (Firebase Auth: email/password, Firestore: email + tÃ¼m profil bilgileri)
- `POST /auth/login` - KullanÄ±cÄ± giriÅŸi
- `POST /auth/reset-password` - Åifre sÄ±fÄ±rlama
- `GET /auth/profile` - KullanÄ±cÄ± profili (Firestore'dan)
- `PUT /auth/update-profile` - Profil gÃ¼ncelleme (sadece deÄŸiÅŸebilen alanlar: email, ÅŸifre, boy, kilo, alerjiler, hastalÄ±klar, ilaÃ§lar, ameliyatlar)
- `DELETE /auth/delete-account` - Hesap silme (Firebase Auth + Firestore + Chat History)

### ğŸ’¬ Chat

- `POST /chat/` - Normal chat (tek yanÄ±t)
- `POST /chat/stream` - Streaming chat (anlÄ±k yanÄ±t)
- `GET /chat/session` - Session bilgisi
- `DELETE /chat/session` - Session temizleme
- `GET /chat/history` - Chat geÃ§miÅŸi

### ğŸ”Š Text-to-Speech

**Frontend-based TTS** desteÄŸi mevcuttur. API response'unda `supports_tts: true` ile TTS'nin kullanÄ±labileceÄŸi belirtilir.

**Ã–zellikler:**

- âœ… Web Speech API kullanÄ±mÄ±
- âœ… SÄ±fÄ±r sunucu yÃ¼kÃ¼
- âœ… TÃ¼rkÃ§e optimize
- âœ… GerÃ§ek zamanlÄ±

**Implementasyon:** `frontend-tts-guide.js` dosyasÄ±nda detaylÄ± kod Ã¶rneÄŸi bulunmaktadÄ±r.

### ğŸ›  Admin

- `GET /admin/sessions` - TÃ¼m session'larÄ± listele
- `DELETE /admin/sessions` - TÃ¼m session'larÄ± temizle

### ğŸ“Š System

- `GET /health` - Sistem durumu
- `GET /docs` - API dokÃ¼mantasyonu

### Katman YapÄ±sÄ±

1. **Presentation Layer** (`routes.py`): API endpoint'leri
2. **Business Layer** (`service.py`): Ä°ÅŸ mantÄ±ÄŸÄ±
3. **Data Layer** (`dependencies.py`, `model_manager.py`): Veri eriÅŸimi
4. **Configuration Layer** (`settings.py`): KonfigÃ¼rasyon yÃ¶netimi

### Ã–nemli BileÅŸenler

#### ModelManager

- ML model yÃ¼kleme ve yÃ¶netimi
- GPU/CPU optimizasyonlarÄ±
- Streaming ve normal yanÄ±t Ã¼retimi

#### SessionManager

- KullanÄ±cÄ± session'larÄ±nÄ±n yÃ¶netimi
- Memory window'lar ile konuÅŸma geÃ§miÅŸi
- Thread-safe iÅŸlemler

#### ChatService

- Chat iÅŸ mantÄ±ÄŸÄ±nÄ±n merkezi yÃ¶netimi
- Model ve session manager'lar arasÄ± koordinasyon
- Error handling ve logging

## ğŸ”§ KonfigÃ¼rasyon

### Firebase Entegrasyonu

Bu API Firebase Authentication ve Firestore kullanÄ±r:

#### Firebase Auth'ta Saklanan Bilgiler:

- Email (kimlik doÄŸrulama iÃ§in)
- Password (ÅŸifrelenmiÅŸ)

#### Firestore'da Saklanan Bilgiler:

- Email (Firebase Auth ile senkronize)
- First Name, Last Name
- Gender (Cinsiyet)
- Allergies (Alerjiler)
- Diseases (HastalÄ±klar)
- Medications (Ä°laÃ§lar)
- Age (YaÅŸ)
- Height (Boy)
- Weight (Kilo)
- Past Surgeries (GeÃ§miÅŸ Ameliyatlar)
- Chat History (Sohbet GeÃ§miÅŸi)

#### Profil GÃ¼ncelleme KÄ±sÄ±tlamalarÄ±:

**DeÄŸiÅŸmeyen Alanlar (KayÄ±t sÄ±rasÄ±nda belirlenir):**

- First Name (Ad)
- Last Name (Soyad)
- Age (YaÅŸ)
- Gender (Cinsiyet)

**DeÄŸiÅŸebilen Alanlar:**

- Email (Firebase Auth + Firestore'da gÃ¼ncellenir)
- Password (Firebase Auth + Firestore'da gÃ¼ncellenir)
- Height (Boy)
- Weight (Kilo)
- Allergies (Alerjiler)
- Diseases (HastalÄ±klar)
- Medications (Ä°laÃ§lar)
- Past Surgeries (GeÃ§miÅŸ Ameliyatlar)

### Model AyarlarÄ±

`app/config/settings.py` dosyasÄ±nda:

```python
MODEL_ID = "google/medgemma-4b-it"
MAX_NEW_TOKENS = 512
TEMPERATURE = 0.2
MEMORY_WINDOW_SIZE = 8
```

### Firebase AyarlarÄ±

Environment variables ile:

- `API_KEY`: Firebase API anahtarÄ±
- `MESSAGING_SENDER_ID`: Messaging sender ID
- `APP_ID`: Firebase app ID
- `FIREBASE_SERVICE_ACCOUNT_PATH`: Service account JSON dosya yolu

## ğŸ§ª Test Etme

### Health Check

```bash
curl http://localhost:8000/health
```

### KullanÄ±cÄ± KaydÄ±

```bash
curl -X POST "http://localhost:8000/auth/signup" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "123456",
    "first_name": "Ahmet",
    "last_name": "YÄ±lmaz",
    "gender": "Erkek",
    "age": 30,
    "allergies": ["Penisilin"],
    "diseases": ["Diyabet"],
    "medications": ["Ä°nsÃ¼lin"]
  }'
```

### Profil GÃ¼ncelleme

```bash
curl -X PUT "http://localhost:8000/auth/update-profile" \
  -H "Authorization: Bearer <your-token>" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "yeni@example.com",
    "password": "yeni_sifre123",
    "height_cm": 175.5,
    "weight_kg": 70.2,
    "allergies": ["Penisilin", "Lateks"],
    "diseases": ["Diyabet", "Hipertansiyon"],
    "medications": ["Ä°nsÃ¼lin", "Tansiyon ilacÄ±"],
    "past_surgeries": ["Apendisit ameliyatÄ±"]
  }'
```

### Chat Test (Authentication gerekli)

```bash
curl -X POST "http://localhost:8000/chat/" \
  -H "Authorization: Bearer <your-token>" \
  -H "Content-Type: application/json" \
  -d '{"message": "Merhaba, nasÄ±lsÄ±n?"}'

# Response Ã¶rneÄŸi:
# {
#   "response": "Merhaba! Size nasÄ±l yardÄ±mcÄ± olabilirim?",
#   "session_id": "user123_session456",
#   "supports_tts": true
# }
```

### TTS Test (Frontend)

```javascript
// JavaScript console'da test
const response = await fetch("/chat/", {
  method: "POST",
  headers: {
    Authorization: "Bearer your-token",
    "Content-Type": "application/json",
  },
  body: JSON.stringify({ message: "Test mesajÄ±" }),
});

const data = await response.json();
if (data.supports_tts) {
  // TTS fonksiyonu Ã§aÄŸÄ±r
  tts.speak(data.response);
}
```

## ğŸ”’ GÃ¼venlik Ã–zellikleri

- **Firebase Authentication**: GÃ¼venli kullanÄ±cÄ± kimlik doÄŸrulama
- **Token-based Authorization**: JWT token ile endpoint korumasÄ±
- **Data Separation**: Hassas bilgiler Firebase Auth'ta, ek bilgiler Firestore'da
- **Account Deletion**: Hesap silme iÅŸlemi tÃ¼m verileri temizler (Auth + Firestore + Chat History)
